"use strict";var mat4x={};mat4x.copyPosition=function(a,b){return a[12]=b[12],a[13]=b[13],a[14]=b[14],a},mat4x.compose=function(a,b,c,d){return mat4.identity(a),mat4.scale(a,a,d),mat4.fromRotationTranslation(a,c,b),a};var ListenerList=function(){};ListenerList.prototype=Object.create(Array.prototype),ListenerList.prototype.dispatch=function(){var a,b;for(a=0,b=this.length;b>a;a++)this[a].apply(null,arguments)};var Object3D=function(){this.matrix=mat4.create(),this.matrixWorld=mat4.create(),this.position=vec3.create(),this.scale=vec3.create(),vec3.set(this.scale,1,1,1),this.quaternion=quat.create(),this.children=[]};Object3D.prototype.updateMatrix=function(){mat4x.compose(this.matrix,this.position,this.quaternion,this.scale)},Object3D.prototype.updateMatrixWorld=function(a){a?mat4.multiply(this.matrixWorld,a,this.matrix):mat4.copy(this.matrixWorld,this.matrix);for(var b=this.children,c=0,d=b.length;d>c;c++)b[c].updateMatrixWorld(this.matrixWorld)};var CSS3DObject=function(a){Object3D.call(this),this.element=a,this.element.style.position="absolute"};CSS3DObject.prototype=Object.create(Object3D.prototype);var CSS3DSprite=function(a){CSS3DObject.call(this,a)};CSS3DSprite.prototype=Object.create(CSS3DObject.prototype);var Camera=function(){Object3D.call(this),this.matrixWorldInverse=mat4.create(),this.fov=75,mat4.invert(this.matrixWorldInverse,this.matrixWorld)};Camera.prototype=Object.create(Object3D.prototype),Camera.prototype.updateMatrixWorld=function(a){Object3D.prototype.updateMatrixWorld.call(this,a),mat4.invert(this.matrixWorldInverse,this.matrixWorld)};var Renderer=function(){var a,b,c,d,e=mat4.create(),f=(vec3.create(),document.createElement("div"));f.style.overflow="hidden",f.style.WebkitTransformStyle="preserve-3d",f.style.MozTransformStyle="preserve-3d",f.style.oTransformStyle="preserve-3d",f.style.transformStyle="preserve-3d",this.domElement=f;var g=document.createElement("div");g.style.WebkitTransformStyle="preserve-3d",g.style.MozTransformStyle="preserve-3d",g.style.oTransformStyle="preserve-3d",g.style.transformStyle="preserve-3d",f.appendChild(g),this.setSize=function(e,h){a=e,b=h,c=a/2,d=b/2,f.style.width=e+"px",f.style.height=h+"px",g.style.width=e+"px",g.style.height=h+"px"};var h=function(a){return Math.abs(a)<1e-6?0:a},i=function(a){return"matrix3d("+h(a[0])+","+h(-a[1])+","+h(a[2])+","+h(a[3])+","+h(a[4])+","+h(-a[5])+","+h(a[6])+","+h(a[7])+","+h(a[8])+","+h(-a[9])+","+h(a[10])+","+h(a[11])+","+h(a[12])+","+h(-a[13])+","+h(a[14])+","+h(a[15])+")"},j=function(a){return"translate3d(-50%,-50%,0) matrix3d("+h(a[0])+","+h(a[1])+","+h(a[2])+","+h(a[3])+","+h(-a[4])+","+h(-a[5])+","+h(-a[6])+","+h(-a[7])+","+h(a[8])+","+h(a[9])+","+h(a[10])+","+h(a[11])+","+h(a[12])+","+h(a[13])+","+h(a[14])+","+h(a[15])+")"},k=function(a,b){if(a instanceof CSS3DObject){var c;a.updateMatrixWorld(),a instanceof CSS3DSprite?(mat4.transpose(e,b.matrixWorldInverse),mat4x.copyPosition(e,a.matrixWorld),mat4.scale(e,e,a.scale),e[3]=0,e[7]=0,e[11]=0,e[15]=1,c=j(e)):c=j(a.matrixWorld);var d=a.element;d.style.WebkitTransform=c,d.style.MozTransform=c,d.style.oTransform=c,d.style.transform=c,d.parentNode!==g&&g.appendChild(d)}for(var f=0,h=a.children.length;h>f;f++)k(a.children[f],b)},l=Math.PI/180;this.render=function(a,e){var h=.5/Math.tan(.5*e.fov*l)*b;f.style.WebkitPerspective=h+"px",f.style.MozPerspective=h+"px",f.style.oPerspective=h+"px",f.style.perspective=h+"px";var j="translate3d(0,0,"+h+"px)"+i(e.matrixWorldInverse)+" translate3d("+c+"px,"+d+"px, 0)";g.style.WebkitTransform=j,g.style.MozTransform=j,g.style.oTransform=j,g.style.transform=j,k(a,e)}},BattlefieldRenderer=function(a){this.em=a,this.scene=null,this.renderer=null,this.camera=null,this.cameraBeta=0,this.cameraAlpha=0,this.cameraAlphaStart=0,this.cameraBetaStart=0};BattlefieldRenderer.prototype.pushFloorObject=function(){var a=document.createElement("div");a.style.width="1500px",a.style.height="750px",a.style.background="url(asset/checkerboard-gray.png)";var b=new CSS3DObject(a);quat.rotateX(b.quaternion,b.quaternion,Math.PI/2),b.updateMatrix(),this.scene.children.push(b)},BattlefieldRenderer.prototype.pushGrassObjects=function(){for(var a=0;20>a;a++){var b=document.createElement("div");b.style.width="50px",b.style.height="50px",b.style.background="url(asset/grass-50.png)";var c=new CSS3DSprite(b);c.position[1]=25,c.position[0]=1500*Math.random()-750,c.position[2]=750*Math.random()-375,c.updateMatrix(),this.scene.children.push(c)}},BattlefieldRenderer.prototype.render=function(){var a=this,b=this.camera,c=vec3.create(),d=vec3.create();d[1]=1,mat4.lookAt(b.matrix,b.position,c,d),mat4.rotateX(b.matrix,b.matrix,this.cameraBeta),mat4.rotateY(b.matrix,b.matrix,this.cameraAlpha),mat4.copy(b.matrixWorldInverse,b.matrix),window.requestAnimationFrame(function(){a.renderer.render(a.scene,a.camera)})},BattlefieldRenderer.prototype.buildRenderer=function(){var a=this,b=new Renderer;return b.domElement.addEventListener("trackend",function(){},!1),b.setSize(window.innerWidth,window.innerHeight),b.domElement.style.position="absolute",b.domElement.style.top=0,b.domElement.addEventListener("trackstart",function(){a.cameraAlphaStart=a.cameraAlpha,a.cameraBetaStart=a.cameraBeta},!1),b.domElement.addEventListener("track",function(b){a.cameraAlpha=a.cameraAlphaStart+b.dx/screen.width*Math.PI*2,a.cameraBeta=a.cameraBetaStart+b.dy/screen.height*Math.PI*2,a.cameraBeta>0&&(a.cameraBeta=0),a.cameraBeta<-(Math.PI/5)&&(a.cameraBeta=-(Math.PI/5)),a.render()},!1),b},BattlefieldRenderer.prototype.initialize=function(){this.buildScene();var a=new Camera;vec3.set(a.position,0,1e3,1e3),this.camera=a,this.renderer=this.buildRenderer(),this.render()},BattlefieldRenderer.prototype.buildScene=function(){var a=new CharacterDOMRenderer,b=new Object3D;this.scene=b,this.pushFloorObject(),this.pushGrassObjects();var c=this.em;return c.filterByComponent("puppeteer").forEach(function(d,e){var f=1e3*e-500,g=c.filterByComponent("puppet").filter(function(a){return a.puppet.puppeteer==d}),h=g.length,i=650/h,j=h%2,k=(h-j)/2-(1-j)/2,l=i*k;g.forEach(function(c,d){var e=d*i-l,g=new CSS3DSprite(a.createElement(c));g.position[1]=150,g.position[0]=f,g.position[2]=e,g.updateMatrix(),b.children.push(g)})}),this.scene.updateMatrixWorld(),b};var UniqueIdGenerator=function(){this.prefix=Math.floor(4294967295*Math.random()).toString(36)};UniqueIdGenerator.prototype.generate=function(){return this.prefix+"-"+Date.now().toString(36)+"-"+Math.floor(4294967295*Math.random()).toString(36)};var Entity=function(a){this.id=a,this.on={attachComponent:new ListenerList,detachComponent:new ListenerList}};Entity.prototype.attachComponent=function(a){a.attach(this),this.on.attachComponent.dispatch(this,a,a.propertyName)},Entity.prototype.detachComponent=function(a){var b=this[a];b&&(b.detach(this),delete this[a],this.on.detachComponent.dispatch(this,b,a))};var EntityManager=function(){this.generator=new UniqueIdGenerator,this.entities={},this.entitiesArray=[]};EntityManager.prototype.create=function(){var a=this.generator.generate(),b=new Entity(a);return Array.prototype.forEach.call(arguments,function(a){a.attach(b)},this),this.entities[a]=b,this.entitiesArray.push(b),b},EntityManager.prototype.get=function(a){return this.entities[a]},EntityManager.prototype.filterByComponent=function(a){return this.entitiesArray.filter(function(b){return b.hasOwnProperty(a)})};var BaseComponent=function(){this.propertyName=null,this.facade={}};BaseComponent.prototype.defineFacadeProperty=function(a){Object.defineProperty(this.facade,a,{enumerable:!1,configurable:!1,get:function(a){return this[a]}.bind(this,a)})},BaseComponent.prototype.attach=function(a){if(!this.propertyName)throw new Error("TODO");Object.seal(this.facade),a[this.propertyName]=this},BaseComponent.prototype.detach=function(a){if(!this.propertyName)throw new Error("TODO");delete a[this.propertyName]};var GaugeComponent=function(a,b){BaseComponent.apply(this,arguments),this.value=a,this.max=b,this.defineFacadeProperty("value"),this.defineFacadeProperty("max")};GaugeComponent.prototype=Object.create(BaseComponent.prototype);var HPGaugeComponent=function(){GaugeComponent.apply(this,arguments),this.propertyName="hp"};HPGaugeComponent.prototype=Object.create(GaugeComponent.prototype);var MPGaugeComponent=function(){GaugeComponent.apply(this,arguments),this.propertyName="mp"};MPGaugeComponent.prototype=Object.create(GaugeComponent.prototype);var NameComponent=function(a){BaseComponent.apply(this,arguments),this.propertyName="name",this.value=a,this.defineFacadeProperty("value")};NameComponent.prototype=Object.create(BaseComponent.prototype);var PuppetComponent=function(a){BaseComponent.apply(this,arguments),this.propertyName="puppet",this.puppeteer=a};PuppetComponent.prototype=Object.create(BaseComponent.prototype);var PuppeteerComponent=function(){BaseComponent.apply(this,arguments),this.propertyName="puppeteer"};PuppeteerComponent.prototype=Object.create(BaseComponent.prototype);var SelectableComponent=function(a){BaseComponent.apply(this,arguments),this.propertyName="selectable",this.onSelect=a||function(){}};SelectableComponent.prototype=Object.create(BaseComponent.prototype),SelectableComponent.prototype.attach=function(a){this.listener=this.onSelect.bind(this,a),BaseComponent.prototype.attach.apply(this,arguments)};var CharacterDOMRenderer=function(){this.elements={}};CharacterDOMRenderer.prototype.updateElement=function(a){var b=this.elements[a.id];!function(){var c=b.querySelector(".ui-mp"),d=a.mp.value,e=a.mp.max;c.querySelector(".ratio > .current").innerHTML=d,c.querySelector(".ratio > .limit").innerHTML=e,c.querySelector(".bar-outter > .bar-inner").setAttribute("style","width: "+d/e*100+"%")}(),function(){var c=b.querySelector(".ui-hp"),d=a.hp.value,e=a.hp.max;c.querySelector(".ratio > .current").innerHTML=d,c.querySelector(".ratio > .limit").innerHTML=e,c.querySelector(".bar-outter > .bar-inner").setAttribute("style","width: "+d/e*100+"%")}()},CharacterDOMRenderer.prototype.createElement=function(a){var b=document.createElement("div"),c=["character"];return a.hasOwnProperty("selectable")&&(c.push("selectable"),b.addEventListener("click",a.selectable.listener,!1)),a.on.detachComponent.push(function(a,c,d){"selectable"===d&&(b.classList.remove("selectable"),b.removeEventListener("click",c.listener,!1))}),a.on.attachComponent.push(function(a,c,d){"selectable"===d&&(b.classList.add("selectable"),b.addEventListener("click",c.listener,!1))}),b.style.width="115px",b.style.height="300px",b.style.background="url(asset/character.png)",b.className=c.join(" "),b.innerHTML='<div class="ui-status"><div>'+a.name.value+'</div><div class="ui-hp"><div class="header"><span class="title">HP</span> <span class="ratio"><span class="current">0</span>/<span class="limit">0</span></span></div><div class="bar-outter"><span class="bar-inner" style="width: 0%"></span></div></div><div class="ui-mp"><div class="header"><span class="title">MP</span> <span class="ratio"><span class="current">0</span>/<span class="limit">0</span></span></div><div class="bar-outter"><span class="bar-inner" style="width: 0%"></span></div></div></div>',this.elements[a.id]=b,this.updateElement(a),b};var SubjectActionTargetStateMachine=function(a,b){this.selectedSubject=null,this.selectedAction=null,this.player=a,this.ui=null,this.em=b,this.on={cancel:new ListenerList,end:new ListenerList}};SubjectActionTargetStateMachine.prototype.begin=function(){this.makeSubjectsSelectable()},SubjectActionTargetStateMachine.prototype.cancel=function(){this.ui&&(this.ui.parentNode.removeChild(this.ui),this.ui=null),this.em.filterByComponent("selectable").forEach(function(a){a.detachComponent("selectable")}),this.on.cancel.dispatch()},SubjectActionTargetStateMachine.prototype.makeSubjectsSelectable=function(){var a=this,b=SubjectActionTargetStateMachine.prototype.onSelectSubject.bind(this);this.em.filterByComponent("puppet").filter(function(b){return b.puppet.puppeteer==a.player}).forEach(function(a){a.attachComponent(new SelectableComponent(b))})},SubjectActionTargetStateMachine.prototype.onSelectTarget=function(a){this.em.filterByComponent("selectable").forEach(function(a){a.detachComponent("selectable")});for(var b=null,c=document.querySelectorAll(".ui-action"),d=0,e=c.length;e>d;++d)b=c[d],b.parentNode&&b.parentNode.removeChild(b);var f=this.selectedSubject,g=this.selectedAction;this.selectedSubject=null,this.selectedAction=null,this.on.end.dispatch(f,g,a)},SubjectActionTargetStateMachine.prototype.makeTargetsSelectable=function(){var a=SubjectActionTargetStateMachine.prototype.onSelectTarget.bind(this);this.em.filterByComponent("hp").forEach(function(b){b.hasOwnProperty("selectable")||b.attachComponent(new SelectableComponent(a))})},SubjectActionTargetStateMachine.prototype.onSelectSubject=function(a){var b=this;if(a.hasOwnProperty("puppet")&&a.puppet.puppeteer==b.player){a.detachComponent("selectable"),this.selectedSubject=a;var c=document.createElement("DIV"),d=["ui-action"],e=[{action:"SwordAction",label:"Sword"},{action:"FireballAction",label:"Fireball"},{action:"HealAction",label:"Heal"}];c.className=d.join(" "),c.innerHTML="<div>"+a.name.value+"</div><ul>"+e.reduce(function(a,b){return a+'<li data-action="'+b.action+'" class="action-item">'+b.label+"</li>"},"")+'</ul><div class="action-cancel">cancel</div>',document.body.appendChild(c),c.querySelector(".action-cancel").addEventListener("click",function(){b.cancel()},!1);for(var f=function(){for(var a=null,c=this.parentNode.querySelectorAll(".action-item"),d=0,e=c.length;e>d;++d)a=c[d],a.classList.remove("active");this.classList.add("active"),b.selectedAction=this.getAttribute("data-action"),b.makeTargetsSelectable()},g=c.querySelectorAll(".action-item"),h=0,i=g.length;i>h;++h)g[h].addEventListener("click",f,!1);this.ui=c}},function(){var a=new EntityManager,b=a.create(new NameComponent("Player 0"),new PuppeteerComponent),c=a.create(new NameComponent("Player 1"),new PuppeteerComponent);a.create(new NameComponent("character0"),new HPGaugeComponent(1e3,1e3),new MPGaugeComponent(1e3,1e3),new PuppetComponent(b)),a.create(new NameComponent("character2"),new HPGaugeComponent(200,1e3),new MPGaugeComponent(100,100),new PuppetComponent(c)),a.create(new NameComponent("character3"),new HPGaugeComponent(300,1e3),new MPGaugeComponent(100,100),new PuppetComponent(c)),a.create(new NameComponent("character1"),new HPGaugeComponent(400,1e3),new MPGaugeComponent(100,100),new PuppetComponent(c));var d=new SubjectActionTargetStateMachine(b,a);d.on.end.push(function(a,b,c){console.debug(a.name.value,b,c.name.value),e.begin()}),d.on.cancel.push(function(){d.begin()}),d.begin();var e=new SubjectActionTargetStateMachine(c,a);e.on.end.push(function(a,b,c){console.debug(a.name.value,b,c.name.value),d.begin()}),e.on.cancel.push(function(){e.begin()});var f=function(){},g=function(a){this.subject=a,this.target=null};g.prototype=Object.create(f.prototype),g.prototype.act=function(a){a.get(this.subject),a.get(this.target)},window.addEventListener("load",function(){var b=new BattlefieldRenderer(a);b.initialize(),document.body.appendChild(b.renderer.domElement)},!1)}();
